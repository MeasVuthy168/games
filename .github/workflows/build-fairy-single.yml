name: Build Fairy-Stockfish (single-thread)

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/build-fairy-single.yml"

permissions:
  contents: write   # needed only if you enable the auto-commit step below

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Clone Fairy-Stockfish.wasm (source)
        run: |
          set -e
          rm -rf fairy-src
          git clone --depth=1 https://github.com/ianfab/Fairy-Stockfish.wasm.git fairy-src

      - name: Setup emsdk
        uses: mymindstorm/setup-emsdk@v14
        with:
          version: "3.1.56"
          actions-cache-folder: emsdk-cache

      - name: Show emsdk info
        run: |
          emcc -v
          em++ -v

      - name: Force single-thread (disable pthreads) in build config
        working-directory: fairy-src
        run: |
          set -e
          # Some builds honor USE_PTHREADS=0; also tweak config if present.
          if [ -f config.default.mk ]; then
            sed -i 's/^USE_PTHREADS\s*=\s*1/USE_PTHREADS = 0/' config.default.mk || true
          fi
          if [ -f Makefile ]; then
            # Make sure the Makefile respects USE_PTHREADS if passed
            echo "Using Makefile:"
            head -n 80 Makefile || true
          fi

      - name: Build single-thread JS/WASM
        working-directory: fairy-src
        shell: bash
        run: |
          set -e
          # Try common targets used by this repo
          (emmake make -j"$(nproc)" build-js USE_PTHREADS=0 && OUTDIR=dist) \
          || (emmake make -j"$(nproc)" js       USE_PTHREADS=0 && OUTDIR=dist) \
          || (emmake make -j"$(nproc)" wasm     USE_PTHREADS=0 && OUTDIR=wasm) \
          || (echo "No known make target matched. Check repo build instructions." && exit 1)

          echo "OUTDIR=${OUTDIR}"
          ls -l "${OUTDIR}"

          # Find outputs
          JS="$(ls ${OUTDIR}/*fairy*stockfish*.js 2>/dev/null | head -n1 || true)"
          WASM="$(ls ${OUTDIR}/*.wasm 2>/dev/null | head -n1 || true)"

          if [ -z "$JS" ] || [ -z "$WASM" ]; then
            echo "::error::Build finished but could not locate .js/.wasm in ${OUTDIR}"
            find . -maxdepth 3 -type f \( -name '*.js' -o -name '*.wasm' \) -ls
            exit 1
          fi

          mkdir -p ../dist_single
          cp "$JS"   ../dist_single/fairy-stockfish.single.js
          cp "$WASM" ../dist_single/fairy-stockfish.single.wasm
          ls -l ../dist_single

      - name: Upload artifacts (download from Actions)
        uses: actions/upload-artifact@v4
        with:
          name: fairy-single
          path: dist_single/*
          if-no-files-found: error

      # ===== OPTIONAL: commit outputs into your repo under /engine =====
      # Enable this block if you want files available at:
      # https://measvuthy168.github.io/games/engine/fairy-stockfish.single.js
      - name: Commit to /engine for GitHub Pages
        if: ${{ success() }}
        run: |
          set -e
          mkdir -p engine
          cp dist_single/fairy-stockfish.single.* engine/
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add engine/fairy-stockfish.single.js engine/fairy-stockfish.single.wasm
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "chore(engine): update fairy-stockfish.single (CI)"
            git push
          fi
