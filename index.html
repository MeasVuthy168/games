<!doctype html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <title>á¢á»á€á…ááŸ’ášá„áŸ’á‚ (Khmer Chess)</title>

  <!-- Khmer Font (Krasar) -->
  <style>
    @font-face{
      font-family:"Krasar";
      src:url("assets/fonts/Krasar-Regular.ttf") format("truetype");
      font-weight:400; font-style:normal; font-display:swap;
    }
    @font-face{
      font-family:"Krasar";
      src:url("assets/fonts/Krasar-Regular.ttf") format("truetype");
      font-weight:700; font-style:normal; font-display:swap;
    }
    :root{
      --ui-font: "Krasar","Noto Sans Khmer",
                 system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;
      --blue:#0d2d5c;
    }
    html,body,.home-app,.home-app *{ font-family:var(--ui-font); }
  </style>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0d2d5c" />
  <link rel="apple-touch-icon" href="assets/icons/icon-192.png" />
  <script src="js/pwa.js" defer></script>
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Main cards */
    .menu-grid{
      display:grid; grid-template-columns:repeat(2,1fr);
      gap:1rem; padding:1rem;
    }
    .menu-card{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      background:#fff; padding:1rem; border-radius:1rem; text-decoration:none; color:#0d2d5c;
      box-shadow:0 4px 12px rgba(0,0,0,.08);
      font-weight:700; cursor:pointer; font-size:1.05rem;
    }
    .menu-card:active{ transform:scale(.98) }
    .card-emoji{ font-size:2.2rem; margin-bottom:.4rem }
    .avatar{ width:36px; height:36px; border-radius:50%; object-fit:cover }

    /* Modal */
    .modal{ position:fixed; inset:0; z-index:1000; display:none }
    .modal.show{ display:block }
    .modal-backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(2px) }
    .modal-card{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(520px,92vw); background:#fff; border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.28); overflow:hidden;
    }
    .modal-header{
      display:flex; align-items:center; justify-content:center;
      padding:12px 14px; background:#0d2d5c; color:#fff;
    }
    .modal-body{ padding:14px; display:grid; gap:12px }
    .level-row{ display:grid; grid-template-columns:repeat(2,1fr); gap:10px }
    @media (min-width:540px){ .level-row{ grid-template-columns:repeat(4,1fr) } }
    .level-btn{
      border:1px solid #d8e1f0; background:#fff; border-radius:12px;
      padding:.7rem .5rem; font-weight:800; text-align:center; cursor:pointer;
      transition:transform .06s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .level-btn:active{ transform:translateY(1px) }
    .level-btn:hover{ box-shadow:0 6px 16px rgba(0,0,0,.08) }
    .level-btn[data-level="Master"]{ border-color:#b1976b }
    .level-hint{ font-size:.86rem; opacity:.8 }
    .radio-row{ display:flex; gap:14px; align-items:center; flex-wrap:wrap }
    .secondary{
      background:#fff; color:#0f172a; border:1px solid #d8e1f0;
      border-radius:10px; padding:.6rem .9rem; font-weight:800;
    }
    .row-right{ display:flex; gap:10px; justify-content:flex-end }
    .last-choice{ font-size:.86rem; opacity:.85; color:#334155; }
    .pill{
      display:inline-block; padding:.12rem .5rem; border-radius:999px;
      background:#eef4ff; color:#0d2d5c; font-weight:800; font-size:.86rem;
      margin-inline-start:.35rem;
    }
  </style>
</head>
<body>
  <div class="app home-app">
    <!-- Top bar -->
    <header class="topbar">
      <h1>á¢á»á€á…ááŸ’ášá„áŸ’á‚ (Khmer Chess)</h1>
      <div class="spacer"></div>
      <a href="settings.html" class="avatar-link" title="Setting">
        <img src="assets/icons/icon-192.png" alt="user" class="avatar" />
      </a>
    </header>

    <!-- Main -->
    <main class="home-main">
      <button id="installBtn" class="install-btn" style="display:none">
        ğŸ“² á’áŸ’áœá¾á€á¶ášááŸ†á¡á¾á„á€á˜áŸ’á˜áœá·á’á¸ (Install App)
      </button>

      <div class="menu-grid">
        <button id="btnVsAI" class="menu-card" type="button" aria-haspopup="dialog" aria-controls="aiModal">
          <div class="card-emoji">ğŸ¤–</div>
          <span>á›áŸá„á‡á¶á˜á½á™ AI</span>
          <small id="aiLast" class="last-choice" style="display:none"></small>
        </button>

        <a id="btnFriend" class="menu-card" href="play.html?mode=friend">
          <div class="card-emoji">ğŸ‘¥</div>
          <span>á›áŸá„á‡á¶á˜á½á™á˜á·ááŸ’á</span>
        </a>
      </div>
    </main>

    <!-- Bottom navigation -->
    <footer id="appTabbar" class="bottom-bar">
      <a class="nav-item active" href="index.html" aria-current="page">
        <img class="ni-img" src="assets/ui/nav-home.png" alt=""><span>Home</span>
      </a>
      <a class="nav-item" href="friends.html">
        <img class="ni-img" src="assets/ui/nav-friends.png" alt=""><span>Friend</span>
      </a>
      <a class="nav-item" href="play.html">
        <img class="ni-img" src="assets/ui/nav-play.png" alt=""><span>Play</span>
      </a>
      <a class="nav-item" href="settings.html">
        <img class="ni-img" src="assets/ui/nav-settings.png" alt=""><span>Setting</span>
      </a>
      <a class="nav-item" href="notifications.html">
        <img class="ni-img" src="assets/ui/nav-bell.png" alt=""><span>Notification</span>
      </a>
    </footer>
    <div id="bottomSpacer" aria-hidden="true"></div>
  </div>

  <!-- AI Level chooser modal -->
  <div class="modal" id="aiModal" aria-hidden="true">
    <div class="modal-backdrop" data-close></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="aiTitle">
      <header class="modal-header">
        <h3 id="aiTitle">á‡áŸ’ášá¾áŸá€á˜áŸ’ášá·á AI</h3>
      </header>
      <div class="modal-body">
        <div class="level-row">
          <button class="level-btn" data-level="Easy"   title="á†á¶á”áŸ‹ášá áŸáŸ áŸá˜áŸ’ášá¶á”áŸ‹á¢áŸ’á“á€ááŸ’á˜á¸">Easy</button>
          <button class="level-btn" data-level="Medium" title="á›áŸá„á˜á¶á“á áŸáá»á•á› (áŸá˜áŸ’ášá¶á”áŸ‹á—á¶á‚á…áŸ’ášá¾á“)">Medium</button>
          <button class="level-btn" data-level="Hard"   title="á‡á˜áŸ’ášáŸ…á…áŸ’ášá¾á“ áá·á…á€áŸ†á á»áŸ">Hard</button>
          <button class="level-btn" data-level="Master" title="á€á˜áŸ’ášá·áá¢áŸ’á“á€á‡áŸ†á“á¶á‰ (ááŸ’á›á¶áŸ†á„á‡á¶á„)">Master</button>
        </div>
        <div class="level-hint">á€á˜áŸ’ášá·á <b>Master</b> á”áŸ’ášá¾á‡á˜áŸ’ášáŸ…áŸáŸ’áœáŸ‚á„ášá€ááŸ’á–áŸáŸ‹á‡á¶á„ á“á·á„áŸáŸ€áœá—áŸ…á”á¾á€ (Khmer book) á†áŸ’á›á¶áá‡á¶á„áŸ”</div>

        <div class="radio-row" style="margin-top:6px">
          <label><input type="radio" name="whoWhite" value="me" checked> ááŸ’á‰á»áŸ† (White)</label>
          <label><input type="radio" name="whoWhite" value="ai"> AI (White)</label>
        </div>

        <div class="row-right">
          <button class="secondary" data-close>á”á·á‘</button>
        </div>
      </div>
    </div>
  </div>

  <!-- NEW: preload WASM pro engine so Master is instant -->
  <script type="module">
    import './js/engine-pro.js';
  </script>

  <script>
    /* ---------- Bottom bar spacer + autohide ---------- */
    (function(){
      const bar = document.getElementById('appTabbar');
      const spacer = document.getElementById('bottomSpacer');
      if(bar && spacer){
        function setSpacer(){
          const h = bar.offsetHeight || 56;
          spacer.style.height = `calc(${h}px + env(safe-area-inset-bottom))`;
        }
        if(document.readyState === 'complete') setSpacer();
        else window.addEventListener('load', setSpacer, {once:true});
        window.addEventListener('resize', setSpacer, {passive:true});

        const here = location.pathname.split('/').pop() || 'index.html';
        for(const a of bar.querySelectorAll('a')){
          if((a.getAttribute('href')||'').endsWith(here)) a.classList.add('active');
          else a.classList.remove('active');
        }

        let lastY = window.scrollY;
        window.addEventListener('scroll', ()=>{
          const y = window.scrollY;
          const down = y > lastY;
          bar.style.transform = down ? 'translateY(110%)' : 'translateY(0)';
          lastY = y;
        }, {passive:true});
      }
    })();

    /* ---------- Settings helpers ---------- */
    const LS_KEY = 'kc_settings_v1';
    function loadSettings(){
      try{ return JSON.parse(localStorage.getItem(LS_KEY) || 'null') || {}; }
      catch{ return {}; }
    }
    function saveSettings(s){ localStorage.setItem(LS_KEY, JSON.stringify(s)); }

    /* ---------- Show last AI choice on card ---------- */
    (function showLastChoice(){
      const s = loadSettings();
      if(!s || !s.aiEnabled) return;
      const wrap = document.getElementById('aiLast');
      const lastLevel = s.aiLevel || 'Medium';
      const who = (s.aiColor === 'w') ? 'AI (White)' : 'ááŸ’á‰á»áŸ† (White)';
      wrap.style.display = 'block';
      wrap.innerHTML = 'á€áŸ†áááŸ‹á…á»á„á€áŸ’ášáŸ„á™áŸ– ' + lastLevel + '<span class="pill">' + who + '</span>';
    })();

    /* ---------- AI modal ---------- */
    const aiModal = document.getElementById('aiModal');
    const openModal = () => { aiModal.classList.add('show'); aiModal.setAttribute('aria-hidden','false'); };
    const closeModal = () => { aiModal.classList.remove('show'); aiModal.setAttribute('aria-hidden','true'); };

    document.getElementById('btnVsAI').addEventListener('click', openModal);
    aiModal.querySelectorAll('[data-close]').forEach(el=>el.addEventListener('click', closeModal));
    aiModal.addEventListener('click', (e)=>{ if(e.target.classList.contains('modal-backdrop')) closeModal(); });

    window.addEventListener('keydown', (e)=>{
      if(!aiModal.classList.contains('show')) return;
      if(e.key === 'Escape'){ e.preventDefault(); closeModal(); }
      if(e.key === 'Enter'){
        const focus = document.activeElement;
        if(focus && focus.classList && focus.classList.contains('level-btn')) focus.click();
      }
    });

    aiModal.querySelectorAll('.level-btn').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const level = btn.getAttribute('data-level') || 'Medium';
        const whoWhite = (document.querySelector('input[name="whoWhite"]:checked') || {}).value || 'me';

        const s = loadSettings();
        s.aiEnabled = true;
        s.aiLevel = level;                 // Easy | Medium | Hard | Master
        s.aiColor = (whoWhite === 'ai') ? 'w' : 'b';  // who plays White
        saveSettings(s);

        location.href = 'play.html?mode=ai';
      });
    });

    document.getElementById('btnFriend').addEventListener('click',()=>{
      const s = loadSettings(); s.aiEnabled = false; saveSettings(s);
    });
  </script>
</body>
</html>
