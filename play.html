<!doctype html>
<html lang="km">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,maximum-scale=1,user-scalable=no" />
  <title>á¢á»á€á…ááŸ’ášá„áŸ’á‚ (Khmer Chess)</title>

  <!-- Font -->
  <link rel="preload" as="font" href="assets/fonts/Krasar-Regular.ttf" type="font/ttf" crossorigin>

  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0d2d5c" />
  <meta name="screen-orientation" content="portrait">
  <meta name="x5-orientation" content="portrait">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <script src="js/pwa.js" defer></script>

  <!-- Board textures -->
  <style>
    :root{
      --board-light-img: url("assets/board/wood_light.jpg");
      --board-dark-img:  url("assets/board/wood_dark.jpg");
      --blue:#0d2d5c;
    }

    /* ==== AI Spinner & Tap Blocker ==== */
    .ai-mask{
      position:fixed; inset:0;
      background:rgba(13,45,92,.06);
      backdrop-filter: blur(1px);
      display:none;
      z-index:9999;
    }
    .ai-mask.on{ display:block }

    .ai-card{
      position:absolute; left:50%; top:42%;
      transform:translate(-50%,-50%);
      background:#fff; color:#0d2d5c;
      border-radius:14px; padding:14px 18px;
      box-shadow:0 10px 30px rgba(0,0,0,.18);
      font-family:"Krasar","Noto Sans Khmer",system-ui;
      text-align:center; min-width:220px;
    }
    .ai-row{ display:flex; align-items:center; gap:10px; justify-content:center }
    .ai-dot{
      width:8px; height:8px; border-radius:50%;
      background:#0d2d5c; opacity:.25;
      animation: ai-b 1.1s linear infinite;
    }
    .ai-dot:nth-child(2){ animation-delay:.15s }
    .ai-dot:nth-child(3){ animation-delay:.3s }
    @keyframes ai-b{
      0%{ transform:translateY(0); opacity:.25 }
      50%{ transform:translateY(-6px); opacity:.9 }
      100%{ transform:translateY(0); opacity:.25 }
    }
    .ai-sub{ font-size:.9rem; margin-top:6px; opacity:.8 }

    /* ==== Debug panel (only if ?debug=1) ==== */
    .dbg{ display:none; margin:12px; padding:10px; border-radius:10px; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.08); }
    .dbg.on{ display:block }
    .dbg h3{ margin:0 0 6px 0; font-size:1.05rem; color:#0d2d5c }
    .dbg .row{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:8px }
    .dbg button{ padding:.55rem .8rem; border-radius:10px; border:0; background:#0d2d5c; color:#fff; font-weight:700 }
    .dbg .out{ font-family:ui-monospace,Consolas,monospace; font-size:.9rem; white-space:pre-wrap; background:#0b254514; padding:8px; border-radius:8px; max-height:160px; overflow:auto }
    .pill{ display:inline-block; padding:.15rem .5rem; border-radius:999px; background:#eef4ff; color:#0d2d5c; font-weight:800; font-size:.85rem }
  </style>

  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div id="app" class="app">
    <main class="layout layout-single">
      <section class="panel board-panel">

        <!-- Turn + counting draw -->
        <div class="turn-wrap">
          <div id="turnLabel" class="turn-banner">áœáŸá“áá¶á„ (áŸ)</div>

          <span id="count-label" class="count-label" style="display:none;">
            â³ <b>ášá¶á”áŸ‹áŸáŸ’á˜á¾áŸ– <span id="count-number">â€“</span></b>
          </span>
          <div id="count-bar" class="count-bar" style="display:none;">
            <div id="count-bar-fill" class="count-bar-fill"></div>
            <span id="count-badge" class="count-badge">â€“</span>
          </div>

          <audio id="snd-count-start" preload="auto" src="assets/sfx/count-start.mp3"></audio>
          <audio id="snd-count-end"   preload="auto" src="assets/sfx/count-end.mp3"></audio>
        </div>

        <!-- Controls -->
        <div class="controls controls-top">
          <button id="btnReset" class="btn-icon primary" title="á…á¶á”áŸ‹á•áŸ’áŠá¾á˜ááŸ’á˜á¸">
            <img src="assets/ui/reset.png" width="22" height="22" alt="">
            <span>á…á¶á”áŸ‹á•áŸ’áŠá¾á˜ááŸ’á˜á¸</span>
          </button>

          <button id="btnPause" class="btn-icon secondary" title="Pause/Resume">
            <img src="assets/ui/pause.png" width="22" height="22" alt="">
            <span>á•áŸ’á¢á¶á€</span>
          </button>

          <button id="btnUndo" class="btn-icon secondary" title="áá™á€áŸ’ášáŸ„á™">
            <img src="assets/ui/undo.png" width="22" height="22" alt="">
            <span>áá™á€áŸ’ášáŸ„á™</span>
          </button>
        </div>

        <!-- Top clock -->
        <div class="timers">
          <div class="player-row top">
            <div class="player-name">ááŸ’á˜áŸ… (Black)</div>
            <div class="clock" id="clockB">10:00.0</div>
          </div>
        </div>

        <!-- Board -->
        <div id="board" class="board board-wood no-coords" aria-label="Khmer Chess Board"></div>

        <!-- Bottom clock -->
        <div class="timers">
          <div class="player-row bottom">
            <div class="player-name">áŸ (White)</div>
            <div class="clock" id="clockW">10:00.0</div>
          </div>
        </div>

        <!-- Debug panel (hidden unless ?debug=1) -->
        <section id="dbg" class="dbg">
          <h3>ğŸ§ª Debug / Test</h3>
          <div class="row">
            <button id="dbgPing">Ping Backend</button>
            <button id="dbgAsk">Ask AI from current</button>
            <button id="dbgForceRemote">Force Remote</button>
            <button id="dbgForceLocal">Force Local</button>
            <button id="dbgClearForce">Clear Force</button>
          </div>
          <div class="row"><span>Mode:</span><span id="dbgMode" class="pill">â€“</span></div>
          <div id="dbgOut" class="out"></div>
        </section>

      </section>
    </main>

    <!-- Bottom nav -->
    <footer id="appTabbar" class="bottom-bar">
      <a class="nav-item" href="index.html"><img class="ni-img" src="assets/ui/nav-home.png" alt=""><span>Home</span></a>
      <a class="nav-item" href="friends.html"><img class="ni-img" src="assets/ui/nav-friends.png" alt=""><span>Friend</span></a>
      <a class="nav-item active" href="play.html" aria-current="page"><img class="ni-img" src="assets/ui/nav-play.png" alt=""><span>Play</span></a>
      <a class="nav-item" href="settings.html"><img class="ni-img" src="assets/ui/nav-settings.png" alt=""><span>Setting</span></a>
      <a class="nav-item" href="notifications.html"><img class="ni-img" src="assets/ui/nav-bell.png" alt=""><span>Notification</span></a>
    </footer>
    <div id="bottomSpacer" aria-hidden="true"></div>
  </div>

  <!-- Portrait-only overlay -->
  <div class="orientation-blocker" id="orientationBlock" aria-hidden="true">
    <div class="ob-card">
      áŸá¼á˜á”áŸ’ášá¾á‘á˜áŸ’ášá„áŸ‹á”á‰áŸ’áˆáš<br/>
      <small>Rotate back to portrait to continue</small>
    </div>
  </div>

  <!-- ==== AI Spinner / tap blocker ==== -->
  <div id="aiMask" class="ai-mask" aria-hidden="true">
    <div class="ai-card" role="status" aria-live="polite">
      <div class="ai-row">
        <div class="ai-dot"></div><div class="ai-dot"></div><div class="ai-dot"></div>
        <b>ğŸ¤– AI á€áŸ†á–á»á„á‚á·á...</b>
      </div>
      <div id="aiSub" class="ai-sub">á”áŸ’ášá—á–áŸ– â€“</div>
    </div>
  </div>

  <!-- JS -->
  <script type="module" src="./js/main.js"></script>
  <script type="module" src="./js/ai-hook.js"></script>

  <!-- global helpers for spinner + debug pills -->
  <script>
    (function(){
      const mask = document.getElementById('aiMask');
      const sub  = document.getElementById('aiSub');
      const dbgMode = () => document.getElementById('dbgMode');

      window.__aiShow = (from) => {
        if (from && sub) sub.textContent = 'á”áŸ’ášá—á–áŸ– ' + (from==='remote' ? 'Remote (Render)' : 'Local');
        mask?.classList.add('on');
        dbgMode()?.replaceChildren(document.createTextNode(from||'â€“'));
      };
      window.__aiHide = ()=> mask?.classList.remove('on');
    })();

    // Debug panel: show only with ?debug=1
    (function(){
      const u = new URL(location.href);
      if (u.searchParams.get('debug') === '1') {
        document.getElementById('dbg')?.classList.add('on');
        const out = document.getElementById('dbgOut');
        function log(s){ out.textContent = s + '\n' + out.textContent; }

        const BE = (localStorage.getItem('kc_backend_url') || 'https://ouk-ai-backend.onrender.com').replace(/\/+$/,'');
        document.getElementById('dbgPing').onclick = async ()=>{
          const url = BE + '/health';
          try{ const r = await fetch(url); log('PING ' + url + ' -> ' + r.status); }
          catch(e){ log('PING failed: ' + e); }
        };
        document.getElementById('dbgAsk').onclick = async ()=>{
          try{
            // we donâ€™t import here; rely on ai.js global selection via ai-hook
            const fen = window.game?.fen?.() || window.game?.toFEN?.() || '(no FEN)';
            log('Ask from FEN: ' + fen);
            // trigger AI turn manually
            window.dispatchEvent(new CustomEvent('dbg-ask-ai'));
          }catch(e){ log('Ask failed: ' + e); }
        };
        document.getElementById('dbgForceRemote').onclick = ()=>{ localStorage.setItem('kc_force_ai','remote'); log('Force: remote'); };
        document.getElementById('dbgForceLocal').onclick  = ()=>{ localStorage.setItem('kc_force_ai','local');  log('Force: local');  };
        document.getElementById('dbgClearForce').onclick  = ()=>{ localStorage.removeItem('kc_force_ai');       log('Force cleared'); };
      }
    })();
  </script>
</body>
</html>
